# Kubernetes Bootstrap (Ubuntu 24.04 / K8s 1.34)

Модульный и надежный установщик кластеров Kubernetes на Ubuntu 24.04, оптимизированный для современного оборудования (NVIDIA GPU, NVMe) и работы в сетях с ограничениями (поддержка Proxy).

## Использование

### 1. Установка Master-ноды
Запустите этот скрипт на машине, которая будет управлять кластером.

```bash
# Базовая установка
sudo ./install-master.sh

# С дополнительными модулями (например, DNS)
sudo ./install-master.sh --modules "dns"

# С использованием HTTP Proxy (если интернет через VPN/Proxy)
sudo ./install-master.sh --proxy "http://127.0.0.1:10888"
```

**Что произойдет?**
- Установка Containerd 2.2, Runc 1.4, K8s 1.34.
- Инициализация кластера (`kubeadm init`).
- Настройка сети Calico (VXLAN, режим Iptables).
- Автоматическое обнаружение NVIDIA GPU и установка драйверов.
- Развертывание хранилища Longhorn и локального Registry.

### 2. Установка Worker-ноды
Запустите этот скрипт на остальных машинах, чтобы добавить их в кластер.

```bash
# Присоединение к кластеру (скопируйте команду вывода kubeadm join с мастера)
sudo ./install-worker.sh <флаги-джойна...>

# Пример:
sudo ./install-worker.sh 192.168.1.133:6443 --token <токен> --discovery-token-ca-cert-hash sha256:<хеш>
```

### 3. Mesh-оверлей (VLESS)
Используйте, когда ноды не могут общаться напрямую. Mesh переводит ноды на `10.10.0.0/24` (по умолчанию) и прописывает kubelet `--node-ip` в mesh-адрес.

**Master (control-plane)**:
```bash
sudo ./vless-mesh/setup-server --pub-addr <MASTER_PUBLIC_IP>
# Опционально: --mesh-ip auto (по умолчанию), --image-registry registry:443/
```
Примечания:
- `setup-server` запускает tinc/xray, пишет `/etc/vless-mesh/*` и по умолчанию выставляет kubelet `--node-ip` на mesh-IP.
- Если `kubectl` настроен, автоматически применяет DaemonSet клиентов на все не-control-plane ноды (используйте `--no-k8s-clients`, чтобы отключить).

**Worker (одной командой)**:
```bash
sudo ./install-worker.sh \
  --mesh-server-addr <MASTER_PUBLIC_IP> \
  --mesh-token <TOKEN> \
  --mesh-ip auto \
  <флаги-join...>
```
Примечания:
- `install-worker.sh` отключает proxy env перед `kubeadm join`.
- Чтобы заранее поднять mesh без join, запускайте ту же команду без флагов join.

---

## Подробное описание проекта

Этот репозиторий содержит набор модульных скриптов для автоматизации жизненного цикла кластера Kubernetes. Он решает типичные проблемы "нулевого дня", такие как настройка GPU, персистентное хранилище и сетевые конфликты в домашних/лабораторных средах.

### Архитектура

*   **Модульность**: Логика разделена на ядро (`k8s-bootstrap`), установщик мастера (`install-master.sh`) и воркера (`install-worker.sh`).
*   **Версионирование**: Используются строго заданные версии: Kubernetes **v1.34.3**, Containerd **v2.2.0**, NVIDIA Toolkit **v1.18**.
*   **Самолечение (Self-Healing)**: Скрипты автоматически проверяют хост на ошибки (например, отсутствие `localhost` в `/etc/hosts` или проблемы с Proxy) и исправляют их.

### Ключевые возможности

#### 1. Поддержка NVIDIA GPU
Установщик сам проверяет наличие GPU (`lspci`).
*   Устанавливает **NVIDIA Container Toolkit**.
*   Настраивает `containerd` на использование рантайма `nvidia`.
*   Устанавливает **NVIDIA Device Plugin** (v1.0.0-beta4) и создает `RuntimeClass`.
*   *Результат*: Поды могут сразу запрашивать ресурс `nvidia.com/gpu: 1`.

#### 2. Хранилище (Longhorn)
*   Разворачивает **Longhorn** для распределенного блочного хранилища.
*   Включает модуль `longhorn-disk-prep` (DaemonSet), который автоматически форматирует и монтирует свободные диски (>5GB) для использования в Longhorn.
*   Меняет дефолтный StorageClass на `longhorn-ssd` для скорости.

#### 3. Сеть (Calico)
*   Использует **Calico v3.31** в режиме Iptables (стабильнее для LXD/VM).
*   Принудительно использует физические интерфейсы (`enp*`), чтобы избежать проблем с MTU на виртуальных мостах.
*   Автоматически настраивает `IPPool` (VXLAN), чтобы не пересекаться с домашней сетью.

#### 4. Локальный Registry
*   Поднимает локальный Docker Registry внутри кластера.
*   Генерирует самоподписанные TLS сертификаты.
*   Автоматически распространяет доверие к этим сертификатам на все ноды через DaemonSet.

### Технические детали

*   **Работа с Proxy**: Скрипты принимают флаг `--proxy` и прописывают его в конфигурацию `systemd` для сервиса `containerd`. Это гарантирует, что образы будут скачиваться, даже если в шелле прокси выключен.
*   **Безопасность**: Установщик создает скрипты удаления (`uninstall-master.sh`, `uninstall-worker.sh`), которые позволяют полностью очистить ноду при необходимости сброса.
